<script src="//maps.google.com/maps/api/js?v=3.13&sensor=false&libraries=geometry" type="text/javascript"></script>
<script src="//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/infobox/1.1.9/src/infobox_packed.js' type='text/javascript'></script>

<link href='https://fonts.googleapis.com/css?family=Josefin+Sans' rel='stylesheet' type='text/css'>

<div style='width: 2900px;'>
  <div id="map" style='width: 950px; height: 550px;'></div>
</div>

<script type="text/javascript">
  var InfoBoxBuilder,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  InfoBoxBuilder = (function(superClass) {
    extend(InfoBoxBuilder, superClass);

    function InfoBoxBuilder() {
      return InfoBoxBuilder.__super__.constructor.apply(this, arguments);
    }

    InfoBoxBuilder.prototype.create_infowindow = function() {
      var boxText;
      if (!_.isString(this.args.infowindow)) {
        return null;
      }
      boxText = document.createElement("div");
      boxText.setAttribute('class', 'marker_container');
      boxText.innerHTML = this.args.infowindow + '/br' + '<p>Hello, Britney!</p>';
      return this.infowindow = new InfoBox(this.infobox(boxText));
    };

    InfoBoxBuilder.prototype.infobox = function(boxText) {
      return {
        content: boxText,
        pixelOffset: new google.maps.Size(-140, 0),
        boxStyle: {
          width: "280px"
        }
      };
    };

    return InfoBoxBuilder;

  })(Gmaps.Google.Builders.Marker);
</script>

<script type="text/javascript">

  $(function() {
    var mapStyle = [
      {"featureType":"administrative","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"administrative","elementType":"geometry.stroke","stylers":[{"visibility":"on"}]},{"featureType":"administrative","elementType":"labels","stylers":[{"visibility":"off"},{"color":"#716464"},{"weight":"0.01"}]},{"featureType":"administrative.country","elementType":"labels","stylers":[{"visibility":"on"}]},{"featureType":"landscape","elementType":"all","stylers":[{"visibility":"simplified"}]},{"featureType":"landscape.natural","elementType":"geometry","stylers":[{"visibility":"simplified"}]},{"featureType":"landscape.natural.landcover","elementType":"geometry","stylers":[{"visibility":"simplified"}]},{"featureType":"poi","elementType":"all","stylers":[{"visibility":"simplified"}]},{"featureType":"poi","elementType":"geometry.fill","stylers":[{"visibility":"simplified"}]},{"featureType":"poi","elementType":"geometry.stroke","stylers":[{"visibility":"simplified"}]},{"featureType":"poi","elementType":"labels.text","stylers":[{"visibility":"simplified"}]},{"featureType":"poi","elementType":"labels.text.fill","stylers":[{"visibility":"simplified"}]},{"featureType":"poi","elementType":"labels.text.stroke","stylers":[{"visibility":"simplified"}]},{"featureType":"poi.attraction","elementType":"geometry","stylers":[{"visibility":"on"}]},{"featureType":"road","elementType":"all","stylers":[{"visibility":"on"}]},{"featureType":"road.highway","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"road.highway","elementType":"geometry","stylers":[{"visibility":"on"}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"visibility":"on"}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"visibility":"simplified"},{"color":"#a05519"},{"saturation":"-13"}]},{"featureType":"road.local","elementType":"all","stylers":[{"visibility":"on"}]},{"featureType":"transit","elementType":"all","stylers":[{"visibility":"simplified"}]},{"featureType":"transit","elementType":"geometry","stylers":[{"visibility":"simplified"}]},{"featureType":"transit.station","elementType":"geometry","stylers":[{"visibility":"on"}]},{"featureType":"water","elementType":"all","stylers":[{"visibility":"simplified"},{"color":"#84afa3"},{"lightness":52}]},{"featureType":"water","elementType":"geometry","stylers":[{"visibility":"on"}]},{"featureType":"water","elementType":"geometry.fill","stylers":[{"visibility":"on"}]}
    ]

    var handler = Gmaps.build('Google');
    // var handler = Gmaps.build('Google', { builders: { Marker: InfoBoxBuilder } } );

    handler.buildMap({ provider: {
      disableDefaultUI: true,
      maxZoom: 2,
      styles: mapStyle
    }, internal: {id: 'map'}}, function() {
        markers = handler.addMarkers(<%=raw @hash.to_json %>);
        console.log('markers:', markers);
    // markers = handler.addMarkers([
    //   {
    //     "lat": 51.500152,
    //     "lng": -0.126236,
    //     "picture": {
    //       "url": "http://www2.psd100.com/ppp/2013/10/0501/Open-book-icon-1005102438.png",
    //       "width":  32,
    //       "height": 27,
    //       "z-index": 5,
    //     },
    //     "infowindow": "London"
    //   }])
      handler.bounds.extendWith(markers);
      handler.fitMapToBounds();
      handler.getMap().setZoom(2);
    });
  });
</script>
